name: Backend CI

on:
  push:
    branches: [ main, FE-Testing ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/dependabot.yml'
      - 'main_frontend/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/dependabot.yml'
      - 'main_frontend/**'

concurrency:
  group: backend-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-coverage:
    runs-on: ubuntu-latest
    # Skip dependabot PRs to prevent failures from breaking dependency updates
    if: ${{ github.actor != 'dependabot[bot]' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Maven repository for Docker run
        uses: actions/cache@v4
        with:
          path: ./.cache/m2
          key: m2-${{ runner.os }}-${{ hashFiles('main_backend/pom.xml') }}
          restore-keys: |
            m2-${{ runner.os }}-
            m2-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Start services (MySQL)
        run: docker-compose up -d mysql

      - name: Wait for MySQL
        run: |
          for i in {1..60}; do
            if docker exec concert-mysql mysqladmin ping -h 127.0.0.1 -uroot -ppassword --silent; then
              echo "MySQL is up"; break; fi; sleep 2; done

      - name: Pre-pull Docker images (speed up Testcontainers)
        run: |
          docker pull mysql:8.0

      - name: Run backend tests in Docker (with JaCoCo)
        run: |
          set -euo pipefail
          docker-compose run --rm backend-tests bash -lc "mvn -B -T 1C -Djacoco.haltOnFailure=false test jacoco:report"

      - name: Publish test run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-tests-log
          path: backend-tests.log

      - name: Publish JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: main_backend/target/site/jacoco

      - name: Publish Surefire Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: main_backend/target/surefire-reports

      - name: Generate JUnit test summary
        uses: dorny/test-reporter@v2
        if: always()
        continue-on-error: true
        with:
          name: JUnit Tests
          path: main_backend/target/surefire-reports/*.xml
          reporter: java-junit

      - name: Upload coverage to Codecov (optional)
        if: always()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: main_backend/target/site/jacoco/jacoco.xml
          fail_ci_if_error: false

      - name: Save coverage history
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml
          path: main_backend/target/site/jacoco/jacoco.xml
