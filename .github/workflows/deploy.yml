name: Deploy Concert Platform to AWS

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: concert-backend
  
jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: maven
      
      - name: Run backend tests
        working-directory: ./main_backend
        run: |
          chmod +x mvnw
          ./mvnw test
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './main_frontend/concert1/package-lock.json'
      
      - name: Run frontend tests
        working-directory: ./main_frontend/concert1
        run: |
          npm ci
          npm run test
  
  build-and-deploy-backend:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: maven
      
      - name: Build Spring Boot application
        working-directory: ./main_backend
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests
      
      - name: Build, tag, and push Docker image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        working-directory: ./main_backend
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
      
      - name: Deploy to EC2 via SSM
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=concert-asg-instance" \
            --parameters 'commands=[
              "docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest",
              "docker stop concert-backend || true",
              "docker rm concert-backend || true",
              "docker run -d --name concert-backend -p 8080:8080 \
                -e DB_HOST=${{ secrets.RDS_ENDPOINT }} \
                -e DB_NAME=concertdb \
                -e DB_USER=admin \
                -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
                -e REDIS_HOST=${{ secrets.REDIS_ENDPOINT }} \
                -e REDIS_PORT=6379 \
                -e AWS_REGION=${{ env.AWS_REGION }} \
                -e S3_EVENT_BUCKET=${{ secrets.S3_EVENT_BUCKET }} \
                -e S3_AVATAR_BUCKET=${{ secrets.S3_AVATAR_BUCKET }} \
                -e COGNITO_USER_POOL_ID=${{ secrets.COGNITO_USER_POOL_ID }} \
                -e COGNITO_CLIENT_ID=${{ secrets.COGNITO_CLIENT_ID }} \
                ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest"
            ]' \
            --region ${{ env.AWS_REGION }}
      
      - name: Verify deployment
        run: |
          sleep 30
          INSTANCE_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=concert-asg-instance" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          
          curl -f http://$INSTANCE_IP:8080/api/auth/test || exit 1
          echo "Deployment successful!"
  
  build-and-deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './main_frontend/concert1/package-lock.json'
      
      - name: Build Nuxt application
        working-directory: ./main_frontend/concert1
        env:
          NUXT_PUBLIC_API_BASE: http://52.203.64.85:8080
          NUXT_PUBLIC_COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
          NUXT_PUBLIC_COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
        run: |
          npm ci
          npm run build
      
      - name: Deploy to S3 (if using S3 static hosting)
        working-directory: ./main_frontend/concert1
        run: |
          # Optional: Deploy static frontend to S3
          # aws s3 sync .output/public s3://your-frontend-bucket --delete
          echo "Frontend build complete"
  
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build-and-deploy-backend, build-and-deploy-frontend]
    if: always()
    
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.build-and-deploy-backend.result }}" == "success" ] && \
             [ "${{ needs.build-and-deploy-frontend.result }}" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi
