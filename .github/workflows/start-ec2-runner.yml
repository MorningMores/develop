name: Start EC2 Runner and Test

on:
  workflow_dispatch:
    inputs:
      instance_type:
        description: 'EC2 Instance Type'
        required: true
        default: 't3.medium'
        type: choice
        options:
        - t3.medium
        - t3.large
        - t3.xlarge

jobs:
  start-ec2:
    name: Start EC2 Runner
    runs-on: ubuntu-latest
    outputs:
      instance-id: ${{ steps.start.outputs.instance-id }}
      runner-name: ${{ steps.start.outputs.runner-name }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Start EC2 instance
        id: start
        run: |
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id ami-0c02fb55956c7d316 \
            --instance-type ${{ github.event.inputs.instance_type }} \
            --key-name concert-key \
            --security-group-ids sg-0123456789abcdef0 \
            --subnet-id subnet-0123456789abcdef0 \
            --user-data file://setup-runner.sh \
            --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=github-runner-temp},{Key=Purpose,Value=CI}]' \
            --query 'Instances[0].InstanceId' \
            --output text)
          
          echo "instance-id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "runner-name=runner-$INSTANCE_ID" >> $GITHUB_OUTPUT
          
          aws ec2 wait instance-running --instance-ids $INSTANCE_ID
          echo "Instance $INSTANCE_ID is running"

  run-tests:
    name: Run Tests on EC2
    needs: start-ec2
    runs-on: [self-hosted, linux, temp-runner]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run backend tests
        run: |
          cd main_backend
          mvn clean test -Dspring.profiles.active=test

      - name: Run frontend tests
        run: |
          cd main_frontend/concert1
          npm ci --legacy-peer-deps
          npm run test

  cleanup:
    name: Cleanup EC2
    needs: [start-ec2, run-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Terminate EC2 instance
        run: |
          aws ec2 terminate-instances --instance-ids ${{ needs.start-ec2.outputs.instance-id }}
          echo "Terminated instance ${{ needs.start-ec2.outputs.instance-id }}"